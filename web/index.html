<!DOCTYPE html>
<html>

<head>
    <title>경기/서울 버스 정류장 리스트맵</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" type="text/css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }

        .ol-popup:after,
        .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }

        .ol-popup:after {
            border-color: rgba(255, 255, 255, 0);
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }

        .ol-popup:before {
            border-color: rgba(204, 204, 204, 0);
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }

        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }

        .ol-popup-closer:after {
            content: "✖";
        }
    </style>
</head>

<body>
    <div id="map" class="map"></div>
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
    <script>
        // 지도 초기화
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([126.9780, 37.5665]),
                zoom: 13
            })
        });

        const seoulVectorSource = new ol.source.Vector();
        const ggdVectorSource = new ol.source.Vector();

        const seoulVectorLayer = new ol.layer.Vector({
            source: seoulVectorSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({ color: '#ff0000' }), // 빨간색 마커
                    stroke: new ol.style.Stroke({
                        color: '#ffffff', // 흰색 테두리
                        width: 2
                    })
                })
            })
        });

        const ggdVectorLayer = new ol.layer.Vector({
            source: ggdVectorSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({ color: '#0000ff' }), // 파란색 마커
                    stroke: new ol.style.Stroke({
                        color: '#ffffff', // 흰색 테두리
                        width: 2
                    })
                })
            })
        });

        map.addLayer(seoulVectorLayer);
        map.addLayer(ggdVectorLayer);

        // 서울 버스 정류장 데이터를 가져와서 지도에 마커 추가
        const fetchSeoulBusStops = async (bbox) => {
            try {
                const response = await fetch(`https://bus.lidar.blog/api/seoul/bus_stops?bbox=${bbox}`);
                const data = await response.json();
                seoulVectorSource.clear(); // 기존 마커 제거
                data.forEach(stop => {
                    const feature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([stop.x, stop.y])),
                        name: stop.name,
                        ars_id: stop.ars_id,
                        stop_type: stop.stop_type
                    });
                    seoulVectorSource.addFeature(feature);
                });
            } catch (error) {
                console.error('Error fetching Seoul bus stops:', error);
            }
        };

        // 경기도 버스 정류장 데이터를 가져와서 지도에 마커 추가
        const fetchGGDBusStops = async (bbox) => {
            try {
                const response = await fetch(`https://bus.lidar.blog/api/ggd/bus_stops?bbox=${bbox}`);
                const data = await response.json();
                ggdVectorSource.clear(); // 기존 마커 제거
                data.forEach(stop => {
                    const feature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([stop.longitude, stop.latitude])),
                        name: stop.stop_name,
                        stop_id: stop.stop_id,
                        stop_number: stop.stop_number
                    });
                    ggdVectorSource.addFeature(feature);
                });
            } catch (error) {
                console.error('Error fetching GGD bus stops:', error);
            }
        };

        const updateBusStops = () => {
            const extent = map.getView().calculateExtent(map.getSize());
            const bbox = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326').join(',');
            fetchSeoulBusStops(bbox);
            fetchGGDBusStops(bbox);
        };

        map.on('moveend', updateBusStops);
        map.once('rendercomplete', updateBusStops); // 초기 로드 시에도 호출

        // 팝업 기능 추가
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        const overlay = new ol.Overlay({
            element: container,
            autoPan: true,
            autoPanAnimation: {
                duration: 250
            }
        });
        map.addOverlay(overlay);

        closer.onclick = function () {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };

        map.on('singleclick', function (evt) {
            const coordinate = evt.coordinate;
            const features = map.getFeaturesAtPixel(evt.pixel);

            if (features.length > 0) {
                const feature = features[0];
                const name = feature.get('name');
                const ars_id = feature.get('ars_id') || feature.get('stop_id');
                const stop_type = feature.get('stop_type') || feature.get('stop_number');
                content.innerHTML = `<b>${name}</b><br>ARS ID: ${ars_id}<br>정류소타입: ${stop_type}`;
                overlay.setPosition(coordinate);
            } else {
                overlay.setPosition(undefined);
                closer.blur();
            }
        });
    </script>
</body>

</html>